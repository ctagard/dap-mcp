name: Publish Packages

on:
  release:
    types: [published]

jobs:
  # Publish to Packagecloud (provides apt/yum repos)
  publish-packagecloud:
    name: Publish to Packagecloud
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifacts
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.ref_name }}
          fileName: "*.deb"
          out-file-path: packages/

      - name: Download RPM artifacts
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.ref_name }}
          fileName: "*.rpm"
          out-file-path: packages/

      - name: Install packagecloud CLI
        run: |
          gem install package_cloud

      - name: Push Debian packages
        env:
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
        run: |
          for distro in ubuntu/focal ubuntu/jammy ubuntu/noble debian/bullseye debian/bookworm; do
            for pkg in packages/*.deb; do
              [ -f "$pkg" ] && package_cloud push ctagard/dap-mcp/$distro $pkg || true
            done
          done

      - name: Push RPM packages
        env:
          PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}
        run: |
          for distro in fedora/39 fedora/40 el/8 el/9; do
            for pkg in packages/*.rpm; do
              [ -f "$pkg" ] && package_cloud push ctagard/dap-mcp/$distro $pkg || true
            done
          done

  # Publish to Snapcraft
  publish-snap:
    name: Publish to Snapcraft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snapcraft

      - name: Publish to Snap Store
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAP_TOKEN }}
        with:
          snap: ${{ steps.snapcraft.outputs.snap }}
          release: stable

  # Publish Docker to multiple registries
  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true  # Don't fail if no Docker Hub creds

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/ctagard/dap-mcp:${{ steps.version.outputs.VERSION }}
            ghcr.io/ctagard/dap-mcp:latest
            ctagard/dap-mcp:${{ steps.version.outputs.VERSION }}
            ctagard/dap-mcp:latest
          labels: |
            org.opencontainers.image.title=dap-mcp
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=https://github.com/ctagard/dap-mcp
